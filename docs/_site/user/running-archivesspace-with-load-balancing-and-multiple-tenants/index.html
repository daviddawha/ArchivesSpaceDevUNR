<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Running ArchivesSpace with load balancing and multiple tenants - ArchivesSpace</title>
    <link rel="stylesheet" href="/archivesspace/assets/stylesheets/main.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" defer></script>
    <script src="/archivesspace/assets/javascripts/site.js" type="text/javascript" charset="utf-8" defer></script>
    <script src="/archivesspace/assets/javascripts/main.js" type="text/javascript" charset="utf-8" defer></script>
    <link rel="alternate" type="application/atom+xml" href="/blog.xml">
  </head>
  <body>
    <div class="wrapper">

      <header class="top">
  <div class="row topbar">
    <h1 id="logo" class="logo">
  <a href="http://archivesspace.org/" title="ArchivesSpace">ArchivesSpace</a>
</h1>

    <nav>
      <ul id="navigation" class="navigation">
        <li><a href="https://archivesspace.atlassian.net/wiki/display/ADC/ArchivesSpace">Wiki</a></li>
        <li><a href="http://docs.archivesspace.org">User Docs</a></li>
        <li class="toggle"><button type="button" id="toggle-menu" class="button--teal">Menu</button></li>
      </ul>
    </nav>
  </div>
</header>


      <div id="content" class="row">

        <div id="sidebar" class="sidebar">
  <div>
    <!-- <h2>Search</h2> -->
    <div class="searchbox">
      <form onsubmit='google_site_search()'>
        <input type="text" id="google-search" class="searchbox-input" label="Search the docs searchbox" placeholder="Search the docs" />
      </form>

      <script language="Javascript" type="text/javascript">
          function google_site_search()
            {
                var query = document.getElementById("google-search").value;
                  window.open("http://google.com/search?q=" + query
                  + "%20site:" + "http://archivesspace.github.io/archivesspace");
                  }
                </script>
    </div>
  </div>
  <section>
    <nav>
      <h2>Basic administration</h2>
      <ul>
        <li><a href="/archivesspace/user/getting-started-with-archivesspace/">Getting started with ArchivesSpace</a></li>
        <li><a href="/archivesspace/user/running-archivesspace-as-a-unix-daemon/">ArchivesSpace as a Unix daemon</a></li>
        <li><a href="/archivesspace/user/running-archivesspace-as-a-windows-service/">ArchivesSpace as a Windows Service</a></li>
        <li><a href="/archivesspace/user/backup-and-recovery/">Backup and Recovery</a></li>
        <li><a href="/archivesspace/user/re-creating-indexes/">Re-creating Indexes</a></li>
        <li><a href="/archivesspace/user/resetting-passwords/">Resetting Passwords</a></li>
        <li><a href="/archivesspace/user/upgrading-to-a-new-release-of-archivesspace/">Upgrading ArchivesSpace</a>
          <ul style="margin-left: 10px;">
            <li><a href="/archivesspace/user/upgrading-to-1.1.0/">Upgrading to 1.1.0</a></li>
            <li><a href="/archivesspace/user/upgrading-to-1.1.1/">Upgrading to 1.1.1</a></li>
            <li><a href="/archivesspace/user/upgrading-to-1.5.0/">Upgrading to 1.5.0</a></li>
            <li><a href="/archivesspace/user/what-is-the-new-functionality-related-to-containers-and-container-management-in-1.5.0/">Container Management in 1.5.0</a></li>
            <li><a href="/archivesspace/user/upgrading-to-2.1.0/">Upgrading to 2.1.0</a></li>
          </ul>
        </li>
      </ul>
      <h2>Architecture and components</h2>
      <ul>
        <li><a href="/archivesspace/user/archivesspace-architecture-and-components">Architecture Overview</a></li>
        <li><a href="/archivesspace/user/jsonmodel----a-validated-archivesspace-record/">JSONModel -- a validated ArchivesSpace record</a></li>
        <li><a href="/archivesspace/user/the-archivesspace-backend/">ArchivesSpace backend</a></li>
        <li><a href="/archivesspace/user/background-jobs/">Background Jobs</a></li>
        <li><a href="/archivesspace/user/working-with-the-archivesspace-api/">ArchivesSpace API</a></li>
        <li><a href="/archivesspace/user/search-indexing/">Search Indexing</a></li>
        <li><a href="/archivesspace/user/the-archivesspace-public-user-interface/">ArchivesSpace Public User Interface</a></li>
        <li><a href="/archivesspace/user/oai-pmh-interface/">OAI-PMH Interface</a></li>
      </ul>
      <h2>Customization and configuration</h2>
      <ul>
        <li><a href="/archivesspace/user/configuring-archivesspace/">Configuring ArchivesSpace</a></li>
        <li><a href="/archivesspace/user/configuring-ldap-authentication/">Configuring LDAP Authentication</a></li>
        <li><a href="/archivesspace/user/adding-support-for-additional-username-password-based-authentication-backends/">Other Authentication Backends</a></li>
        <li><a href="/archivesspace/user/archivesspace-plug-ins/">ArchivesSpace Plug-ins</a></li>
        <li><a href="/archivesspace/user/customizing-text-in-archivesspace/">Customizing Text in ArchivesSpace</a></li>
        <li><a href="/archivesspace/user/theming-archivesspace/">Theming ArchivesSpace</a></li>
        <li><a href="/archivesspace/user/managing-frontend-assets-with-bower/">Managing Frontend Assets with Bower</a></li>
      </ul>
      <h2>Provisioning and server configuration</h2>
      <ul>
        <li><a href="/archivesspace/user/running-archivesspace-with-load-balancing-and-multiple-tenants/">Load Balancing and Multiple Tenants</a></li>
        <li><a href="/archivesspace/user/serving-archivesspace-over-subdomains/">ArchivesSpace with Subdomains</a></li>
        <li><a href="/archivesspace/user/serving-archivesspace-user-facing-applications-over-https/">ArchivesSpace over HTTPS</a></li>
        <li><a href="/archivesspace/user/jmeter-test-group-template/">JMeter Test Group Template</a></li>
        <li><a href="/archivesspace/user/running-archivesspace-against-mysql/">Running ArchivesSpace Against MySQL</a></li>
        <li><a href="/archivesspace/user/application-monitoring-with-new-relic/">Application Monitoring with New Relic</a></li>
        <li><a href="/archivesspace/user/running-archivesspace-under-a-prefix/">ArchivesSpace under a Prefix</a></li>
        <li><a href="/archivesspace/user/running-archivesspace-with-external-solr/">ArchivesSpace with External Solr</a></li>
        <li><a href="/archivesspace/user/tuning-archivesspace/">Tuning ArchivesSpace</a></li>
      </ul>
      <h2>Information for developers and code contributors</h2>
      <ul>
        <li><a href="/archivesspace/user/archivesspace-build-system/">ArchivesSpace Build System</a></li>
        <li><a href="/archivesspace/user/building-an-archivesspace-release/">Building an ArchivesSpace Release</a></li>
        <li><a href="/archivesspace/user/public-test-suite/">Public Test Suite</a></li>
        <li><a href="/archivesspace/user/selenium-test-suite/">Selenium Test Suite</a></li>
        <li><a href="/archivesspace/user/using-supervisord-for-development/">Using supervisord for Development</a></li>
        <li><a href="/archivesspace/user/docker/">Docker</a></li>
        <li><a href="/archivesspace/user/reports/">Reports</a></li>
        <li><a href="https://archivesspace.atlassian.net/wiki/spaces/ADC/pages/16449553/Contributing">Contributing to ArchivesSpace</a>
          <ul style="margin-left: 10px;">
            <li><a href="/archivesspace/user/contributor-license-agreements/">Contributor License Agreements</a></li>
          </ul>
        </li>
        <li><a href="/archivesspace/api">The API</a></li>
        <li><a href="/archivesspace/doc">Ruby YARD Documentation</a></li>
        <li><div class="status-circle status">Status:</div>
          <a href="https://travis-ci.org/archivesspace/archivesspace">Travis CI Status</a>
        </li>
      </ul>
      <h2>Importing and exporting data in ArchivesSpace</h2>
      <ul>
        <li><a href="/archivesspace/user/accession-csv-import-template/">Accession CSV Import Template</a></li>
        <li><a href="/archivesspace/user/assessment-csv-import-template/">Assessment CSV Import Template</a></li>
        <li><a href="/archivesspace/user/digital-object-csv-import-template/">Digital Object CSV Import Template</a></li>
        <li><a href="/archivesspace/user/archivesspace-repository-ead-exporter/">ArchivesSpace Repository EAD Exporter</a></li>
        <li><a href="/archivesspace/user/archivesspace-xsl-stylesheets/">ArchivesSpace XSL Stylesheets</a></li>
      </ul>
      <h2>Migration tools and data mapping</h2>
      <ul>
        <li><a href="/archivesspace/user/migration-tools-and-data-mapping/">Migration Tools and Data Mapping</a>
          <ul style="margin-left: 10px;">
            <li><a href="/archivesspace/user/migrating-data-from-archivists-toolkit-to-archivesspace-using-the-migration-tool/">Archivists' Toolkit Migration Instructions</a></li>
            <li><a href="/archivesspace/user/migrating-data-from-archon-to-archivesspace-using-the-migration-tool/">Archon Migration Instructions</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </section>
  <section>
    <h2>Contact</h2>
    <ul>
      <li><a href="https://twitter.com/archivesspace">Twitter</a></li>
      <li><a href="http://github.com/archivesspace/archivesspace">GitHub</a></li>
      <li><a href="mailto:ArchivesSpaceHome@lyrasis.org">Email</a></li>
    </ul>
  </section>
  <section>
    <h2>Contributing to this Documentation</h2>
    <p>The documentation files for this site are managed in the <a href="https://github.com/archivesspace/tech-docs">ArchivesSpace Technical Documentation Repository</a>.</p>
      <p>This documentation was based on the <a href="https://travis-ci.org">Travis CI</a> documentation. It uses <a href="https://github.com/jekyll/jekyll">Jekyll</a> and <a href="https://github.com/tripit/slate">Slate</a></p>
  </section>
</div><!-- /#sidebar -->


        <main id="main" class="main">
          
            <h1 class="title">Running ArchivesSpace with load balancing and multiple tenants</h2>
          
          <p>This document describes two aspects of running ArchivesSpace in a
clustered environment: for load-balancing purposes, and for supporting
multiple tenants (isolated installations of the system in a common
deployment environment).</p>

<p>The configuration described in this document is one possible approach,
but it is not intended to be prescriptive: the application layer of
ArchivesSpace is stateless, so any mechanism you prefer for load
balancing across web applications should work just as well as the one
described here.</p>

<p>Unless otherwise stated, it is assumed that you have root access on
your machines, and all commands are to be run as root (or with sudo).</p>

<h2 id="architecture-overview">Architecture overview</h2>

<p><img src="/archivesspace/assets/images/overview.png" alt="Overview" /></p>

<p>This document assumes an architecture with the following components:</p>

<ul>
  <li>A load balancer machine running the Nginx web server</li>
  <li>Two application servers, each running a full ArchivesSpace
application stack</li>
  <li>A MySQL server</li>
  <li>A shared NFS volume mounted under <code class="highlighter-rouge">/aspace</code> on each machine</li>
</ul>

<h2 id="overview-of-files">Overview of files</h2>

<p>The <code class="highlighter-rouge">files</code> directory in this repository (in the same directory as this
<code class="highlighter-rouge">README.md</code>) contains what will become the contents of the <code class="highlighter-rouge">/aspace</code>
directory, shared by all servers.  It has the following layout:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /aspace
 ├── archivesspace
 │   ├── config
 │   │   ├── config.rb
 │   │   └── tenant.rb
 │   ├── software
 │   └── tenants
 │       └── \_template
 │           └── archivesspace
 │               ├── config
 │               │   ├── config.rb
 │               │   └── instance_hostname.rb.example
 │               └── init_tenant.sh
 └── nginx
     └── conf
         ├── common
         │   └── server.conf
         └── tenants
             └── \_template.conf.example
</code></pre></div></div>

<p>The highlights:</p>

<ul>
  <li><code class="highlighter-rouge">/aspace/archivesspace/config/config.rb</code> – A global configuration file for all ArchivesSpace instances.  Any configuration options added to this file will be applied to all tenants on all machines.</li>
  <li><code class="highlighter-rouge">/aspace/archivesspace/software/</code> – This directory will hold the master copies of the <code class="highlighter-rouge">archivesspace.zip</code> distribution.  Each tenant will reference one of the versions of the ArchivesSpace software in this directory.</li>
  <li><code class="highlighter-rouge">/aspace/archivesspace/tenants/</code> – Each tenant will have a sub-directory under here, based on the <code class="highlighter-rouge">_template</code> directory provided.  This holds the configuration files for each tenant.</li>
  <li><code class="highlighter-rouge">/aspace/archivesspace/tenants/[tenant name]/config/config.rb</code> – The global configuration file for [tenant name].  This contains tenant-specific options that should apply to all of the tenant’s ArchivesSpace instances (such as their database connection settings).</li>
  <li><code class="highlighter-rouge">/aspace/archivesspace/tenants/[tenant name]/config/instance_[hostname].rb</code> – The configuration file for a tenant’s ArchivesSpace instance running on a particular machine.  This allows configuration options to be set on a per-machine basis (for example, setting different ports for different application servers)</li>
  <li><code class="highlighter-rouge">/aspace/nginx/conf/common/server.conf</code> – Global Nginx configuration settings (applying to all tenants)</li>
  <li><code class="highlighter-rouge">/aspace/nginx/conf/tenants/[tenant name].conf</code> – A tenant-specific Nginx configuration file.  Used to set the URLs of each tenant’s ArchivesSpace instances.</li>
</ul>

<h2 id="getting-started">Getting started</h2>

<p>We’ll assume you already have the following ready to go:</p>

<ul>
  <li>Three newly installed machines, each running RedHat (or CentOS)
Linux (we’ll refer to these as <code class="highlighter-rouge">loadbalancer</code>, <code class="highlighter-rouge">apps1</code> and
<code class="highlighter-rouge">apps2</code>).</li>
  <li>A MySQL server.</li>
  <li>An NFS volume that has been mounted as <code class="highlighter-rouge">/aspace</code> on each machine.
All machines should have full read/write access to this area.</li>
  <li>An area under <code class="highlighter-rouge">/aspace.local</code> which will store instance-specific
files (such as log files and Solr indexes).  Ideally this is just
a directory on local disk.</li>
  <li>Java 1.6 (or above) installed on each machine.</li>
</ul>

<h3 id="populate-your-aspace-directory">Populate your /aspace/ directory</h3>

<p>Start by copying the directory structure from <code class="highlighter-rouge">files/</code> into your
<code class="highlighter-rouge">/aspace</code> volume.  This will contain all of the configuration files
shared between servers:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> mkdir /var/tmp/aspace/
 cd /var/tmp/aspace/
 unzip -x /path/to/archivesspace.zip
 cp -av archivesspace/clustering/files/* /aspace/
</code></pre></div></div>

<p>You can do this on any machine that has access to the shared
<code class="highlighter-rouge">/aspace/</code> volume.</p>

<h3 id="install-the-cluster-init-script">Install the cluster init script</h3>

<p>On your application servers (<code class="highlighter-rouge">apps1</code> and <code class="highlighter-rouge">apps2</code>) you will need to
install the supplied init script:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cp -a /aspace/aspace-cluster.init /etc/init.d/aspace-cluster
 chkconfig --add aspace-cluster
</code></pre></div></div>

<p>This will start all configured instances when the system boots up, and
can also be used to start/stop individual instances.</p>

<h3 id="install-and-configure-nginx">Install and configure Nginx</h3>

<p>You will need to install Nginx on your <code class="highlighter-rouge">loadbalancer</code> machine, which
you can do by following the directions at
http://nginx.org/en/download.html.  Using the pre-built packages for
your platform is fine.  At the time of writing, the process for CentOS
is simply:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> wget http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm
 rpm -i nginx-release-centos-6-0.el6.ngx.noarch.rpm
 yum install nginx
</code></pre></div></div>

<p>Nginx will place its configuration files under <code class="highlighter-rouge">/etc/nginx/</code>.  For
now, the only change we need to make is to configure Nginx to load our
tenants’ configuration files.  To do this, edit
<code class="highlighter-rouge">/etc/nginx/conf.d/default.conf</code> and add the line:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> include /aspace/nginx/conf/tenants/\*.conf;
</code></pre></div></div>

<p><em>Note:</em> the location of Nginx’s main config file might vary between
systems.  Another likely candidate is <code class="highlighter-rouge">/etc/nginx/nginx.conf</code>.</p>

<h3 id="download-the-archivesspace-distribution">Download the ArchivesSpace distribution</h3>

<p>Rather than having every tenant maintain their own copy of the
ArchivesSpace software, we put a shared copy under
<code class="highlighter-rouge">/aspace/archivesspace/software/</code> and have each tenant instance refer
to that copy.  To set this up, run the following commands on any one
of the servers:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd /aspace/archivesspace/software/
 unzip -x /path/to/downloaded/archivesspace-x.y.z.zip
 mv archivesspace archivesspace-x.y.z
 ln -s archivesspace-x.y.z stable
</code></pre></div></div>

<p>Note that we unpack the distribution into a directory containing its
version number, and then assign that version the symbolic name
“stable”.  This gives us a convenient way of referring to particular
versions of the software, and we’ll use this later on when setting up
our tenant.</p>

<p>We’ll be using MySQL, which means we must make the MySQL connector
library available.  To do this, place it in the <code class="highlighter-rouge">lib/</code> directory of
the ArchivesSpace package:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd /aspace/archivesspace/software/stable/lib
 wget https://repo1.maven.org/maven2/mysql/mysql-connector-java/5.1.24/mysql-connector-java-5.1.24.jar
</code></pre></div></div>

<h2 id="defining-a-new-tenant">Defining a new tenant</h2>

<p>With our server setup out of the way, we’re ready to define our first
tenant.  As shown in <em>Overview of files</em> above, each tenant has their
own directory under <code class="highlighter-rouge">/aspace/archivesspace/tenants/</code> that holds all of
their configuration files.  In defining our new tenant, we will:</p>

<ul>
  <li>Create a Unix account for the tenant</li>
  <li>Create a database for the tenant</li>
  <li>Create a new set of ArchivesSpace configuration files for the
tenant</li>
  <li>Set up the database</li>
</ul>

<p>Our newly defined tenant won’t initially have any ArchivesSpace
instances, but we’ll set those up afterwards.</p>

<p>To complete the remainder of this process, there are a few bits of
information you will need.  In particular, you will need to know:</p>

<ul>
  <li>The identifier you will use for the tenant you will be creating.
In this example we use <code class="highlighter-rouge">exampletenant</code>.</li>
  <li>Which port numbers you will use for the application’s backend,
Solr instance, staff and public interfaces.  These must be free on
your application servers.</li>
  <li>If running each tenant under a separate Unix account, the UID and
GID you’ll use for them (which must be free on each of your
servers).</li>
  <li>The public-facing URLs for the new tenant.  We’ll use
<code class="highlighter-rouge">staff.example.com</code> for the staff interface, and <code class="highlighter-rouge">public.example.com</code>
for the public interface.</li>
</ul>

<h3 id="creating-a-unix-account">Creating a Unix account</h3>

<p>Although not strictly required, for security and ease of system
monitoring it’s a good idea to have each tenant instance running under
a dedicated Unix account.</p>

<p>We will call our new tenant <code class="highlighter-rouge">exampletenant</code>, so let’s create a user
and group for them now.  You will need to run these commands on <em>both</em>
application servers (<code class="highlighter-rouge">apps1</code> and <code class="highlighter-rouge">apps2</code>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> groupadd --gid 2000 exampletenant
 useradd --uid 2000 --gid 2000 exampletenant
</code></pre></div></div>

<p>Note that we specify a UID and GID explicitly to ensure they match
across machines.</p>

<h3 id="creating-the-database">Creating the database</h3>

<p>ArchivesSpace assumes that each tenant will have their own MySQL
database.  You can create this from the MySQL shell:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> create database exampletenant default character set utf8;
 grant all on exampletenant.* to 'example'@'%' identified by 'example123';
</code></pre></div></div>

<p>In this example, we have a MySQL database called <code class="highlighter-rouge">exampletenant</code>, and
we grant full access to the user <code class="highlighter-rouge">example</code> with password <code class="highlighter-rouge">example123</code>.
Assuming our database server is <code class="highlighter-rouge">db.example.com</code>, this corresponds to
the database URL:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> jdbc:mysql://db.example.com:3306/exampletenant?user=example&amp;password=example123&amp;useUnicode=true&amp;characterEncoding=UTF-8
</code></pre></div></div>

<p>We’ll make use of this URL in the following section.</p>

<h3 id="creating-the-tenant-configuration">Creating the tenant configuration</h3>

<p>Each tenant has their own set of files under the
<code class="highlighter-rouge">/aspace/archivesspace/tenants/</code> directory.  We’ll define our new
tenant (called <code class="highlighter-rouge">exampletenant</code>) by copying the template set of
configurations and running the <code class="highlighter-rouge">init_tenant.sh</code> script to set them
up.  We can do this on either <code class="highlighter-rouge">apps1</code> or <code class="highlighter-rouge">apps2</code>–it only needs to be
done once:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd /aspace/archivesspace/tenants
 cp -a \_template exampletenant
</code></pre></div></div>

<p>Note that we’ve named the tenant <code class="highlighter-rouge">exampletenant</code> to match the Unix
account it will run as.  Later on, the startup script will use this
fact to run each instance as the correct user.</p>

<p>For now, we’ll just edit the configuration file for this tenant, under
<code class="highlighter-rouge">exampletenant/archivesspace/config/config.rb</code>.  When you open this file you’ll see two
placeholders that need filling in: one for your database URL, which in
our case is just:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> jdbc:mysql://db.example.com:3306/exampletenant?user=example&amp;password=example123&amp;useUnicode=true&amp;characterEncoding=UTF-8
</code></pre></div></div>

<p>and the other for this tenant’s search, staff and public user secrets,
which should be random, hard to guess passwords.</p>

<h2 id="adding-the-tenant-instances">Adding the tenant instances</h2>

<p>To add our tenant instances, we just need to initialize them on each
of our servers.  On <code class="highlighter-rouge">apps1</code> <em>and</em> <code class="highlighter-rouge">apps2</code>, we run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd /aspace/archivesspace/tenants/exampletenant/archivesspace
 ./init_tenant.sh stable
</code></pre></div></div>

<p>If you list the directory now, you will see that the <code class="highlighter-rouge">init_tenant.sh</code>
script has created a number of symlinks.  Most of these refer back to
the <code class="highlighter-rouge">stable</code> version of the ArchivesSpace software we unpacked
previously, and some contain references to the <code class="highlighter-rouge">data</code> and <code class="highlighter-rouge">logs</code>
directories stored under <code class="highlighter-rouge">/aspace.local</code>.</p>

<p>Each server has its own configuration file that tells the
ArchivesSpace application which ports to listen on.  To set this up,
make two copies of the example configuration by running the following
command on <code class="highlighter-rouge">apps1</code> then <code class="highlighter-rouge">apps2</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd /aspace/archivesspace/tenants/exampletenant/archivesspace
 cp config/instance_hostname.rb.example config/instance_`hostname`.rb
</code></pre></div></div>

<p>Then edit each file to set the URLs that the instance will use.
Here’s our <code class="highlighter-rouge">config/instance_apps1.example.com.rb</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> {
   :backend_url =&gt; "http://apps1.example.com:8089",
   :frontend_url =&gt; "http://apps1.example.com:8080",
   :solr_url =&gt; "http://apps1.example.com:8090",
   :indexer_url =&gt; "http://apps1.example.com:8091",
   :public_url =&gt; "http://apps1.example.com:8081",
 }
</code></pre></div></div>

<p>Note that the filename is important here: it must be:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> instance_[server hostname].rb
</code></pre></div></div>

<p>These URLs will determine which ports the application listens on when
it starts up, and are also used by the ArchivesSpace indexing system
to track updates across the cluster.</p>

<h3 id="starting-up">Starting up</h3>

<p>As a one-off, we need to populate this tenant’s database with the
default set of tables.  You can do this by running the
<code class="highlighter-rouge">setup-database.sh</code> script on either <code class="highlighter-rouge">apps1</code> or <code class="highlighter-rouge">apps2</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd /aspace/archivesspace/tenants/exampletenant/archivesspace
 scripts/setup-database.sh
</code></pre></div></div>

<p>With the two instances configured, you can now use the init script to
start them up on each server:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /etc/init.d/aspace-cluster start-tenant exampletenant
</code></pre></div></div>

<p>and you can monitor each instance’s log file under
<code class="highlighter-rouge">/aspace.local/tenants/exampletenant/logs/</code>.  Once they’re started,
you should be able to connect to each instance with your web browser
at the configured URLs.</p>

<h2 id="configuring-the-load-balancer">Configuring the load balancer</h2>

<p>Our final step is configuring Nginx to accept requests for our staff
and public interfaces and forward them to the appropriate application
instance.  Working on the <code class="highlighter-rouge">loadbalancer</code> machine, we create a new
configuration file for our tenant:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd /aspace/nginx/conf/tenants
 cp -a \_template.conf.example exampletenant.conf
</code></pre></div></div>

<p>Now open <code class="highlighter-rouge">/aspace/nginx/conf/tenants/exampletenant.conf</code> in an
editor.  You will need to:</p>

<ul>
  <li>Replace <code class="highlighter-rouge">&lt;tenantname&gt;</code> with <code class="highlighter-rouge">exampletenant</code> where it appears.</li>
  <li>Change the <code class="highlighter-rouge">server</code> URLs to match the hostnames and ports you
configured each instance with.</li>
  <li>Insert the tenant’s hostnames for each <code class="highlighter-rouge">server_name</code> entry.  In
our case these are <code class="highlighter-rouge">public.example.com</code> for the public interface, and
<code class="highlighter-rouge">staff.example.com</code> for the staff interface.</li>
</ul>

<p>Once you’ve saved your configuration, you can test it with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /usr/sbin/nginx -t
</code></pre></div></div>

<p>If Nginx reports that all is well, reload the configurations with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /usr/sbin/nginx -s reload
</code></pre></div></div>

<p>And, finally, browse to <code class="highlighter-rouge">http://public.example.com/</code> to verify that Nginx
is now accepting requests and forwarding them to your app servers.
We’re done!</p>

        </main>
      </div><!-- /#content -->

      <footer>
  <div class="row">
  </div>
</footer>

    </div><!-- /.wrapper -->
  </body>
</html>
