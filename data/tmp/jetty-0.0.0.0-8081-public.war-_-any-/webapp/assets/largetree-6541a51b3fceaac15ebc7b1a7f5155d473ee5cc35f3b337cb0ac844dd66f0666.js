!function(t){"use strict";function e(t,e,o,n,i,a,l){this.source=t,this.elt=e,this.scrollTimer=void 0,this.renderer=i,this.progressIndicator=$('<progress class="largetree-progress-indicator" />'),this.elt.before(this.progressIndicator),this.elt.css("will-change","transform"),this.root_uri=o,this.root_tree_id=r.uri_to_tree_id(o),this.current_tree_id=this.root_tree_id,this.read_only=n,this.waypoints={},this.node_selected_callback=l,this.populateWaypointHooks=[],this.collapseNodeHooks=[],this.errorHandler=$.noop,this.initEventHandlers(),this.renderRoot(function(){a()})}function o(t){this.url=t.replace(/\/+$/,"")}var r={};r.uri_to_tree_id=function(t){var e=r.uri_to_parts(t);return e.type+"_"+e.id},r.uri_to_parts=function(t){var e=t.replace(/\/repositories\/[0-9]+\//,""),o=e.match(/([a-z_]+)\/([0-9]+)/),r=o[1].replace(/\//g,"_"),n=o[2],i=r.replace(/s$/,"");return{type:i,id:n}},r.backend_uri_to_frontend_uri=function(t){return AS.app_prefix(t.replace(/\/repositories\/[0-9]+\//,""))},r.parse_tree_id=function(t){var e=t.match(/([a-z_]+)([0-9]+)/);if(null!=e&&3==e.length){var o=e[1].replace(/_$/,""),r=e[2];return{type:o,id:r}}},r.link_url=function(t){return"#tree::"+r.uri_to_tree_id(t)},t.TreeIds=r;var n=100,i=300;e.prototype.setGeneralErrorHandler=function(t){this.errorHandler=t},e.prototype.currentlyLoading=function(){this.progressIndicator.css("visibility","visible")},e.prototype.doneLoading=function(){var t=this;setTimeout(function(){t.progressIndicator.css("visibility","hidden")},0)},e.prototype.addPlugin=function(t){return t.initialize(this),t},e.prototype.addPopulateWaypointHook=function(t){this.populateWaypointHooks.push(t)},e.prototype.addCollapseNodeHook=function(t){this.collapseNodeHooks.push(t)},e.prototype.displayNode=function(t,e){var o=this,n=r.parse_tree_id(t).id,i=function(){var o=$("#"+t);e&&e(o)};t===o.root_tree_id?i():o.source.fetchPathFromRoot(n).done(function(t){o.recursivelyPopulateWaypoints(t[n],i)})},e.prototype.reparentNodes=function(t,e,o){var r=this;if(!r.isReparentAllowed(e,t))return AS.openQuickModal("Unable to perform move","The move has been disallowed as a parent cannot become its own child."),{done:$.noop};var n=r.elt.scrollTop(),i=r.displayLoadingMask(n),a=t.data("uri");if(a||(a=this.root_uri),o){var l=0;$(e).each(function(t,e){var n=$(e).data("level"),i=$(e).prevAll(".indent-level-"+(n-1)+":first").data("uri");i||(i=r.root_uri),i==a&&$(e).data("position")<o&&(l+=1)}),o-=l}else o=0;var s=[];t.data("uri")&&!t.is(".root-row")&&s.push(t.data("uri")),$(e).each(function(t,e){var o=$(e).data("level"),r=$(e).prevAll(".indent-level-"+(o-1)+":first").data("uri");r&&s.push(r)}),r.elt.find(".expandme .expanded").closest("tr").each(function(t,e){s.push($(e).data("uri"))});var d=[];return $(e).each(function(t,e){d.push($(e).data("uri"))}),this.source.reparentNodes(a,d,o).done(function(){r.redisplayAndShow(s,function(){r.considerPopulatingWaypoint(function(){r.elt.animate({scrollTop:n},function(){i.remove()}),$(e).each(function(t,e){var o=$(e).attr("id");r.elt.find("#"+o).addClass("reparented-highlight"),setTimeout(function(){r.elt.find("#"+o).removeClass("reparented-highlight").addClass("reparented")},500)})})})})},e.prototype.displayLoadingMask=function(t){var e=this,o=e.elt.clone(!1);o.on("click",function(t){return t.preventDefault(),!1}),o.find("*").removeAttr("id"),o.attr("id","tree-container-loading"),o.css("z-index",2e3).css("position","absolute").css("left",e.elt.offset().left).css("top",e.elt.offset().top),o.width(e.elt.width());var r=$('<div class="spinner" />');return r.css("font-size","50px").css("display","inline").css("z-index",2500).css("position","fixed").css("margin",0).css("left","50%").css("top","50%"),$("body").prepend(o),$("body").prepend(r),o.scrollTop(t),{remove:function(){o.remove(),r.remove()}}},e.prototype.redisplayAndShow=function(t,e){var o=this;t=$.unique(t),e||(e=$.noop),o.renderRoot(function(){var n=t.slice(0),i=[],a=function(t){if(t&&i.push(t),0==n.length){var l=function(t){if(i.length>0){var e=i.shift();e.is(".root-row")?t():o.expandNode(e,function(){l(t)})}else t()};return l(function(){return e()})}var s=n.shift(),d=r.uri_to_tree_id(s);o.displayNode(d,a)};a()})},e.prototype.recursivelyPopulateWaypoints=function(t,e){var o=this;if(!t||0===t.length)return void e();var n=t.shift(),i=function(){if(o.waypoints[n.node]){var r=o.waypoints[n.node][n.offset];r&&o.populateWaypoint(r,function(){o.recursivelyPopulateWaypoints(t,e)})}};if(n.node){var a=r.uri_to_tree_id(n.node);$("#"+a).find(".expandme").find(".expanded").length>0?i():o.toggleNode($("#"+a).find(".expandme"),i)}else i()},e.prototype.deleteWaypoints=function(t){var e=t.next();if(!e.hasClass("waypoint"))return!1;if(!e.hasClass("populated"))return e.remove(),!0;var o=e.data("level");if(!o)return!1;for(;;){var r=e.next();if(0===r.length)break;if(r.hasClass("end-marker")&&o==r.data("level")){r.remove();break}r.remove()}return e.remove(),!0},e.prototype.toggleNode=function(t,e){var o=this,r=t.closest("tr");t.data("expanded")?o.collapseNode(r,e):o.expandNode(r,e)},e.prototype.expandNode=function(t,e){var o=this,r=t.find(".expandme");return r.data("expanded")?void(e&&e()):(r.find(".expandme-icon").addClass("expanded"),$(r).data("expanded",!0),!t.data("uri"),void o.source.fetchNode(t.data("uri")).done(function(r){o.appendWaypoints(t,t.data("uri"),r.waypoints,r.waypoint_size,t.data("level")+1),e&&e()}).fail(function(){o.errorHandler.apply(o,["fetch_node_failed"].concat([].slice.call(arguments)))}))},e.prototype.collapseNode=function(t,e){for(var o=this;o.deleteWaypoints(t););var r=t.find(".expandme");$(r).data("expanded",!1),r.find(".expandme-icon").removeClass("expanded"),setTimeout(function(){o.considerPopulatingWaypoint()},0),$(o.collapseNodeHooks).each(function(t,e){e()}),e&&e()},e.prototype.initEventHandlers=function(){var t=this,e=!1;this.elt.on("scroll",function(){t.scrollTimer&&clearTimeout(t.scrollTimer);var o=function(){e||(e=!0,t.considerPopulatingWaypoint(function(){e=!1}))};t.scrollTimer=setTimeout(o,n)}),$(this.elt).on("click",".expandme",function(e){e.preventDefault(),t.toggleNode($(this))})},e.prototype.makeWaypoint=function(t,e,o){var r=$('<tr class="waypoint" />');return r.addClass("indent-level-"+o),r.data("level",o),r.data("uri",t),r.data("offset",e),this.waypoints[t]||(this.waypoints[t]={}),this.waypoints[t][e]=r,r},e.prototype.appendWaypoints=function(t,e,o,r,n){for(var i=t.data("child_count"),a=o-1;a>=0;a--){var l=this.makeWaypoint(e,a,n);l.data("child_count_at_this_level",i),l.css("height",2*r+"em"),t.after(l)}var s=this;setTimeout(function(){s.considerPopulatingWaypoint()},0)},e.prototype.renderRoot=function(t){var e=this;e.waypoints={};var o=$('<table class="root" />');this.source.fetchRootNode().done(function(n){var i=e.renderer.get_root_template();i.data("uri",n.uri),i.attr("id",r.uri_to_tree_id(n.uri)),i.addClass("root-row"),i.data("level",0),i.data("child_count",n.child_count),i.data("jsonmodel_type",n.jsonmodel_type),i.find(".title").append($("<a>").attr("href",r.link_url(n.uri)).addClass("record-title").text(n.title)),o.append(i),e.appendWaypoints(i,null,n.waypoints,n.waypoint_size,1),e.elt.find("table.root").remove(),e.elt.prepend(o),e.renderer.add_root_columns(i,n),t&&t()})},e.prototype.considerPopulatingWaypoint=function(t){var e=this;t||(t=$.noop);var o=parseFloat($("body").css("font-size")),r=o*i,n=this.elt.offset().top,a=this.elt.outerHeight(),l=e.elt.find(".waypoint");if(0==l.length)return void t();for(var s,d=e.elt.scrollTop()/e.elt.find("table.root").height(),p=Math.floor(d*l.length),c=function(t){var e=t.offset().top-n,o=e+t.height(),i=Math.abs(e)<=a+r||Math.abs(o)<=a+r||e<0&&o>0;if(i){var l={elt:t,top:e,level:t.data("level")};return s?(s.level>l.level||s.top>l.top)&&(s=l):s=l,!0}return!1},u=p;u>=0;u--){var f=$(l[u]);if(!f.hasClass("populated")){var h=c(f);if(!h&&u<p)break}}for(var u=p+1;u<l.length;u++){var f=$(l[u]);if(!f.hasClass("populated")){var h=c(f);if(!h)break}}s?(e.currentlyLoading(),e.populateWaypoint(s.elt,function(){setTimeout(function(){e.considerPopulatingWaypoint(t)},0)})):(e.doneLoading(),t())};var a={};e.prototype.populateWaypoint=function(t,e){if(t.hasClass("populated"))return void e();var o=this,n=t.data("uri"),i=t.data("offset"),l=t.data("level"),s=n+"_"+i;a[s]||(a[s]=!0,this.source.fetchWaypoint(n,i).done(function(n){var i=o.renderer.endpoint_marker();i.data("level",l),i.data("child_count_at_this_level",t.data("child_count_at_this_level")),i.addClass("indent-level-"+l),t.after(i);var d=[],p=void 0;$(n).each(function(t,e){var n=o.renderer.get_node_template();n.addClass("largetree-node indent-level-"+l),n.data("level",l),n.data("child_count",e.child_count);var i=n.find(".title"),a=$("<div>").html(e.title).text();i.append($('<a class="record-title" />').prop("href",r.link_url(e.uri)).text(e.title)),i.attr("title",a);var s=n.find(".expandme");s.attr("aria-label","expand element"),0===e.child_count&&(s.css("visibility","hidden"),s.attr("aria-hidden","true")),o.renderer.add_node_columns(n,e);var c=r.uri_to_tree_id(e.uri);n.data("uri",e.uri),n.data("jsonmodel_type",e.jsonmodel_type),n.data("position",e.position),n.data("parent_id",e.parent_id),n.attr("id",c),o.current_tree_id==c?(n.addClass("current"),p=n):n.removeClass("current"),d.push(n)}),t.after.apply(t,d),t.addClass("populated"),a[s]=!1,$(o.populateWaypointHooks).each(function(t,e){e()}),p&&$.proxy(o.node_selected_callback,o)(p,o),e()}))},o.prototype.urlFor=function(t){return this.url+"/"+t},o.prototype.fetchRootNode=function(){var t=this;return $.ajax(this.urlFor("root"),{method:"GET",dataType:"json"}).done(function(e){t.cachePrecomputedWaypoints(e)})},o.prototype.fetchNode=function(t){var e=this;if(!t)throw"Node can't be empty!";return $.ajax(this.urlFor("node"),{method:"GET",dataType:"json",data:{node:t}}).done(function(t){e.cachePrecomputedWaypoints(t)})},o.prototype.fetchPathFromRoot=function(t){return $.ajax(this.urlFor("node_from_root"),{method:"GET",dataType:"json",data:{node_ids:[t]}})},o.prototype.fetchWaypoint=function(t,e){var o=this.getPrecomputedWaypoint(t,e);return o?{done:function(t){t(o)}}:$.ajax(this.urlFor("waypoint"),{method:"GET",dataType:"json",data:{node:t,offset:e}})},o.prototype.reparentNodes=function(t,e,o){var n=r.backend_uri_to_frontend_uri(t);return $.ajax(n+"/accept_children",{method:"POST",data:{children:e,index:o}})};var l={};o.prototype.getPrecomputedWaypoint=function(t,e){var o;return null===t&&(t=""),l[t]&&l[t][e]&&(o=l[t][e],l[t]={}),o},o.prototype.cachePrecomputedWaypoints=function(t){$(Object.keys(t.precomputed_waypoints)).each(function(e,o){l[o]=t.precomputed_waypoints[o]})},e.prototype.setCurrentNode=function(t,e){if($("#"+this.current_tree_id,this.elt).removeClass("current"),this.current_tree_id=t,1==$("#"+this.current_tree_id,this.elt).length){var o=$("#"+this.current_tree_id,this.elt);o.addClass("current"),$.proxy(this.node_selected_callback,self)(o,this),e&&e()}else this.displayNode(this.current_tree_id,e)},e.prototype.isReparentAllowed=function(t,e){if(e.is(".root-row"))return!0;var o=[];o.push(e.data("uri"));for(var r=e.data("level")-1,n=e;r>0;)n=n.prevAll(".largetree-node.indent-level-"+r+":first"),o.push(n.data("uri")),r-=1;var i=!0;return $(t).each(function(t,e){var r=$(e).data("uri");if($.inArray(r,o)>=0)return void(i=!1)}),i},t.LargeTree=e,t.TreeDataSource=o}(window);